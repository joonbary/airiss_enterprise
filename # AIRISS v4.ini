# AIRISS v4.0 DB í†µí•© ë¶„ì„ í…ŒìŠ¤íŠ¸
import requests
import json
import time

# ì„œë²„ ì„¤ì •
BASE_URL = "http://localhost:8002"
FILE_ID = "edfd8024-8580-4808-b73f-188af32ab423"  # 8ë‹¨ê³„ì—ì„œ ì—…ë¡œë“œí•œ íŒŒì¼

def test_analysis_flow():
    """ì—…ë¡œë“œâ†’ë¶„ì„ í”Œë¡œìš° ì™„ì „ í…ŒìŠ¤íŠ¸"""
    
    print("ğŸš€ AIRISS v4.0 DB í†µí•© ë¶„ì„ í…ŒìŠ¤íŠ¸ ì‹œì‘")
    print("=" * 60)
    
    # 1. ì„œë²„ ìƒíƒœ í™•ì¸
    print("1ï¸âƒ£ ì„œë²„ ìƒíƒœ í™•ì¸...")
    try:
        response = requests.get(f"{BASE_URL}/")
        if response.status_code == 200:
            print("âœ… ì„œë²„ ì—°ê²° ì„±ê³µ")
            print(f"   ì‘ë‹µ: {response.json()['message']}")
        else:
            print("âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨")
            return
    except Exception as e:
        print(f"âŒ ì„œë²„ ì—°ê²° ì˜¤ë¥˜: {e}")
        return
    
    # 2. ë¶„ì„ ì‹œì‘
    print("\n2ï¸âƒ£ AIRISS v4.0 í•˜ì´ë¸Œë¦¬ë“œ ë¶„ì„ ì‹œì‘...")
    
    analysis_request = {
        "file_id": FILE_ID,
        "sample_size": 3,           # í…ŒìŠ¤íŠ¸ìš© ì†ŒëŸ‰
        "enable_ai": False          # ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ AI ë¹„í™œì„±í™”
    }
    
    try:
        response = requests.post(
            f"{BASE_URL}/analysis/start",
            json=analysis_request
        )
        
        if response.status_code == 200:
            result = response.json()
            job_id = result['job_id']
            print("âœ… ë¶„ì„ ì‹œì‘ ì„±ê³µ!")
            print(f"   ì‘ì—… ID: {job_id}")
            print(f"   ìƒíƒœ: {result['status']}")
            print(f"   ë©”ì‹œì§€: {result['message']}")
            
            # 3. ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§
            print("\n3ï¸âƒ£ ë¶„ì„ ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§...")
            monitor_analysis(job_id)
            
        else:
            print("âŒ ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨")
            print(f"   ìƒíƒœ ì½”ë“œ: {response.status_code}")
            print(f"   ì‘ë‹µ: {response.text}")
            
    except Exception as e:
        print(f"âŒ ë¶„ì„ ìš”ì²­ ì˜¤ë¥˜: {e}")

def monitor_analysis(job_id):
    """ë¶„ì„ ì§„í–‰ë¥  ëª¨ë‹ˆí„°ë§"""
    
    max_attempts = 30  # ìµœëŒ€ 30ë²ˆ (30ì´ˆ)
    
    for attempt in range(max_attempts):
        try:
            response = requests.get(f"{BASE_URL}/analysis/status/{job_id}")
            
            if response.status_code == 200:
                status = response.json()
                
                print(f"   ğŸ“Š ì§„í–‰ë¥ : {status.get('progress', 0):.1f}% "
                      f"({status.get('processed', 0)}/{status.get('total_employees', 0)})")
                
                if status['status'] == 'completed':
                    print("âœ… ë¶„ì„ ì™„ë£Œ!")
                    
                    # 4. ê²°ê³¼ í™•ì¸
                    print("\n4ï¸âƒ£ ë¶„ì„ ê²°ê³¼ í™•ì¸...")
                    check_results(job_id)
                    break
                    
                elif status['status'] == 'failed':
                    print("âŒ ë¶„ì„ ì‹¤íŒ¨")
                    print(f"   ì˜¤ë¥˜: {status.get('error', 'Unknown error')}")
                    break
                    
                elif status['status'] == 'processing':
                    time.sleep(1)  # 1ì´ˆ ëŒ€ê¸°
                    
            else:
                print(f"âŒ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨: {response.status_code}")
                break
                
        except Exception as e:
            print(f"âŒ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜: {e}")
            break
    else:
        print("â° íƒ€ì„ì•„ì›ƒ: ë¶„ì„ì´ ì˜ˆìƒë³´ë‹¤ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤")

def check_results(job_id):
    """ë¶„ì„ ê²°ê³¼ í™•ì¸"""
    
    try:
        response = requests.get(f"{BASE_URL}/analysis/results/{job_id}")
        
        if response.status_code == 200:
            results = response.json()
            
            print("âœ… ê²°ê³¼ ì¡°íšŒ ì„±ê³µ!")
            print(f"   ì´ ë¶„ì„: {results.get('total_analyzed', 0)}ëª…")
            print(f"   ì‹¤íŒ¨: {results.get('failed', 0)}ëª…")
            
            if 'statistics' in results:
                stats = results['statistics']
                print(f"   í‰ê·  ì ìˆ˜: {stats.get('average_score', 0)}")
                print(f"   ìµœê³  ì ìˆ˜: {stats.get('max_score', 0)}")
                print(f"   ìµœì € ì ìˆ˜: {stats.get('min_score', 0)}")
                
                if 'grade_distribution' in stats:
                    print("   ë“±ê¸‰ ë¶„í¬:")
                    for grade, count in stats['grade_distribution'].items():
                        print(f"     {grade}: {count}ëª…")
            
            # ìƒ˜í”Œ ê²°ê³¼ ì¶œë ¥
            if 'results' in results and results['results']:
                print("\nğŸ“‹ ìƒ˜í”Œ ê²°ê³¼ (ì²˜ìŒ 3ëª…):")
                for i, result in enumerate(results['results'][:3]):
                    print(f"   {i+1}. UID: {result.get('UID', 'N/A')}")
                    print(f"      ì ìˆ˜: {result.get('AIRISS_v4_ì¢…í•©ì ìˆ˜', 0)}")
                    print(f"      ë“±ê¸‰: {result.get('OKë“±ê¸‰', 'N/A')}")
                    print(f"      ì‹ ë¢°ë„: {result.get('ë¶„ì„ì‹ ë¢°ë„', 0)}%")
            
            print("\nğŸ‰ AIRISS v4.0 DB í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ!")
            print("   âœ… ì—…ë¡œë“œ â†’ ë¶„ì„ í”Œë¡œìš° ì™„ì „ ì—°ê²°ë¨")
            
        else:
            print("âŒ ê²°ê³¼ ì¡°íšŒ ì‹¤íŒ¨")
            print(f"   ìƒíƒœ ì½”ë“œ: {response.status_code}")
            print(f"   ì‘ë‹µ: {response.text}")
            
    except Exception as e:
        print(f"âŒ ê²°ê³¼ í™•ì¸ ì˜¤ë¥˜: {e}")

if __name__ == "__main__":
    test_analysis_flow()