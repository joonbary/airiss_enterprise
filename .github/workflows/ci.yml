name: ğŸš€ AIRISS CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # ================================
  # ë°±ì—”ë“œ í…ŒìŠ¤íŠ¸
  # ================================
  backend-test:
    name: ğŸ Backend Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: test_user
          POSTGRES_DB: test_airiss
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ“¦ Cache Python dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: ğŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-asyncio

    - name: ğŸ§ª Run backend tests
      env:
        DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_airiss
        REDIS_URL: redis://localhost:6379/0
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SECRET_KEY: test_secret_key_for_ci
      run: |
        python -m pytest tests/ -v --cov=app --cov-report=xml --cov-report=html

    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: backend
        name: backend-coverage

  # ================================
  # í”„ë¡ íŠ¸ì—”ë“œ í…ŒìŠ¤íŠ¸
  # ================================
  frontend-test:
    name: âš›ï¸ Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: âš›ï¸ Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: 'airiss-v4-frontend/package-lock.json'

    - name: ğŸ“¦ Install frontend dependencies
      working-directory: airiss-v4-frontend
      run: npm ci

    - name: ğŸ” Run ESLint
      working-directory: airiss-v4-frontend
      run: npm run lint

    - name: ğŸ¨ Run Prettier check
      working-directory: airiss-v4-frontend
      run: npm run format:check

    - name: ğŸ§ª Run frontend tests
      working-directory: airiss-v4-frontend
      run: npm run test:ci

    - name: ğŸ—ï¸ Build frontend
      working-directory: airiss-v4-frontend
      run: npm run build

  # ================================
  # ë³´ì•ˆ ê²€ì‚¬
  # ================================
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: ğŸ“¤ Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

    - name: ğŸ Python security check
      run: |
        python -m pip install safety bandit
        safety check --json
        bandit -r app/ -f json -o bandit-report.json || true

  # ================================
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  # ================================
  code-quality:
    name: âœ¨ Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ”§ Install quality tools
      run: |
        python -m pip install --upgrade pip
        pip install black isort flake8 mypy

    - name: ğŸ¨ Check code formatting with Black
      run: black --check app/

    - name: ğŸ“¦ Check import sorting with isort
      run: isort --check-only app/

    - name: ğŸ” Run flake8 linting
      run: flake8 app/

    - name: ğŸ·ï¸ Run mypy type checking
      run: mypy app/ --ignore-missing-imports

  # ================================
  # Docker ë¹Œë“œ í…ŒìŠ¤íŠ¸
  # ================================
  docker-build:
    name: ğŸ³ Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ—ï¸ Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: false
        tags: airiss:test
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ================================
  # í†µí•© í…ŒìŠ¤íŠ¸
  # ================================
  integration-test:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ğŸš€ Start services
      run: |
        # ë°±ì—”ë“œ ì„œë²„ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
        python run_server.py &
        sleep 10

    - name: ğŸ§ª Run integration tests
      run: |
        python integration_test_v4.py

  # ================================
  # ë°°í¬ (main ë¸Œëœì¹˜ë§Œ)
  # ================================
  deploy:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, security-scan, code-quality, docker-build, integration-test]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    environment:
      name: staging
      url: https://airiss-staging.okfinancial.com
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“ Create deployment summary
      run: |
        echo "## ğŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Staging" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Branch**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Trigger**: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Time**: $(date)" >> $GITHUB_STEP_SUMMARY

    # ì‹¤ì œ ë°°í¬ëŠ” ê° í™˜ê²½ì— ë§ê²Œ êµ¬í˜„
    - name: ğŸ¯ Deploy placeholder
      run: |
        echo "ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ê°€ ì—¬ê¸°ì— ë“¤ì–´ê°‘ë‹ˆë‹¤"
        echo "ì˜ˆ: kubectl apply -f k8s/"
        echo "ì˜ˆ: docker-compose up -d"

  # ================================
  # ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  # ================================
  performance-test:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: ğŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install locust

    - name: âš¡ Run performance tests
      run: |
        # Locustë¥¼ ì‚¬ìš©í•œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ì˜ˆì‹œ
        echo "ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰"
        # locust -f tests/performance/locustfile.py --headless -u 10 -r 2 -t 30s --host http://localhost:8002

  # ================================
  # ì•Œë¦¼
  # ================================
  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, security-scan, code-quality]
    if: always()
    
    steps:
    - name: ğŸ“Š Create status report
      run: |
        echo "## ğŸ¯ Build Status Report" >> $GITHUB_STEP_SUMMARY
        echo "- **Backend Tests**: ${{ needs.backend-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Frontend Tests**: ${{ needs.frontend-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Security Scan**: ${{ needs.security-scan.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Code Quality**: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.backend-test.result }}" = "success" ] && [ "${{ needs.frontend-test.result }}" = "success" ]; then
          echo "âœ… **Overall Status**: PASSED" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **Overall Status**: FAILED" >> $GITHUB_STEP_SUMMARY
        fi

    # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
    # - name: ğŸ“± Slack Notification
    #   uses: 8398a7/action-slack@v3
    #   with:
    #     status: ${{ job.status }}
    #     channel: '#airiss-dev'
    #     webhook_url: ${{ secrets.SLACK_WEBHOOK }}
    #   if: always()
