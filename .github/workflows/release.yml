name: ğŸ·ï¸ Release Management

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v4.0.1)'
        required: true
        type: string
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: patch

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ================================
  # ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
  # ================================
  generate-release-notes:
    name: ğŸ“ Generate Release Notes
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.notes.outputs.release_notes }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ·ï¸ Get version
      id: version
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
        else
          echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“ Generate release notes
      id: notes
      run: |
        # ì´ì „ íƒœê·¸ì™€ í˜„ì¬ íƒœê·¸ ì‚¬ì´ì˜ ì»¤ë°‹ ê¸°ë°˜ìœ¼ë¡œ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        CURRENT_TAG="${{ steps.version.outputs.version }}"
        
        echo "# AIRISS $CURRENT_TAG Release Notes" > release_notes.md
        echo "" >> release_notes.md
        echo "## ğŸš€ What's New" >> release_notes.md
        echo "" >> release_notes.md
        
        if [ -n "$PREVIOUS_TAG" ]; then
          echo "### ğŸ“‹ Changes since $PREVIOUS_TAG" >> release_notes.md
          echo "" >> release_notes.md
          
          # ìƒˆë¡œìš´ ê¸°ëŠ¥
          echo "### âœ¨ Features" >> release_notes.md
          git log $PREVIOUS_TAG..HEAD --oneline --grep="feat:" --pretty=format:"- %s (%h)" >> release_notes.md || true
          echo "" >> release_notes.md
          
          # ë²„ê·¸ ìˆ˜ì •
          echo "### ğŸ› Bug Fixes" >> release_notes.md
          git log $PREVIOUS_TAG..HEAD --oneline --grep="fix:" --pretty=format:"- %s (%h)" >> release_notes.md || true
          echo "" >> release_notes.md
          
          # ë¬¸ì„œ ì—…ë°ì´íŠ¸
          echo "### ğŸ“ Documentation" >> release_notes.md
          git log $PREVIOUS_TAG..HEAD --oneline --grep="docs:" --pretty=format:"- %s (%h)" >> release_notes.md || true
          echo "" >> release_notes.md
          
          # ê¸°íƒ€ ê°œì„ ì‚¬í•­
          echo "### ğŸ”§ Improvements" >> release_notes.md
          git log $PREVIOUS_TAG..HEAD --oneline --grep="refactor:\|perf:\|style:" --pretty=format:"- %s (%h)" >> release_notes.md || true
          echo "" >> release_notes.md
        fi
        
        echo "## ğŸ“¦ Installation" >> release_notes.md
        echo "" >> release_notes.md
        echo '```bash' >> release_notes.md
        echo "git clone https://github.com/joonbary/airiss_enterprise.git" >> release_notes.md
        echo "cd airiss_enterprise" >> release_notes.md
        echo "git checkout $CURRENT_TAG" >> release_notes.md
        echo "pip install -r requirements.txt" >> release_notes.md
        echo "python run_server.py" >> release_notes.md
        echo '```' >> release_notes.md
        echo "" >> release_notes.md
        
        echo "## ğŸ”§ Breaking Changes" >> release_notes.md
        echo "" >> release_notes.md
        if git log $PREVIOUS_TAG..HEAD --oneline --grep="BREAKING CHANGE" | grep -q .; then
          git log $PREVIOUS_TAG..HEAD --oneline --grep="BREAKING CHANGE" --pretty=format:"- %s (%h)" >> release_notes.md
        else
          echo "No breaking changes in this release." >> release_notes.md
        fi
        echo "" >> release_notes.md
        
        echo "## ğŸ™ Contributors" >> release_notes.md
        echo "" >> release_notes.md
        git log $PREVIOUS_TAG..HEAD --format='%aN' | sort -u | sed 's/^/- @/' >> release_notes.md || true
        
        # GitHub ì¶œë ¥ìœ¼ë¡œ ì„¤ì •
        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: ğŸ“¤ Upload release notes
      uses: actions/upload-artifact@v3
      with:
        name: release-notes
        path: release_notes.md

  # ================================
  # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
  # ================================
  build-and-push-image:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: generate-release-notes
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: ğŸ”‘ Log in to Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ·ï¸ Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=tag
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}

    - name: ğŸ—ï¸ Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # ================================
  # GitHub ë¦´ë¦¬ì¦ˆ ìƒì„±
  # ================================
  create-github-release:
    name: ğŸ‰ Create GitHub Release
    runs-on: ubuntu-latest
    needs: [generate-release-notes, build-and-push-image]
    permissions:
      contents: write
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“¥ Download release notes
      uses: actions/download-artifact@v3
      with:
        name: release-notes

    - name: ğŸ‰ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.generate-release-notes.outputs.version }}
        name: "AIRISS ${{ needs.generate-release-notes.outputs.version }}"
        body_path: release_notes.md
        draft: false
        prerelease: ${{ contains(needs.generate-release-notes.outputs.version, '-') }}
        generate_release_notes: true
        files: |
          requirements.txt
          CHANGELOG.md
          README.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ================================
  # í”„ë¡œë•ì…˜ ë°°í¬
  # ================================
  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [generate-release-notes, build-and-push-image, create-github-release]
    if: "!contains(needs.generate-release-notes.outputs.version, '-')"
    environment:
      name: production
      url: https://airiss.okfinancial.com
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Set up kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    # ì‹¤ì œ ë°°í¬ ë‹¨ê³„ (í™˜ê²½ì— ë”°ë¼ ìˆ˜ì •)
    - name: ğŸš€ Deploy to Kubernetes
      run: |
        echo "ğŸš€ Deploying AIRISS ${{ needs.generate-release-notes.outputs.version }} to production..."
        echo "ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´:"
        echo "kubectl set image deployment/airiss-backend airiss=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.generate-release-notes.outputs.version }}"
        echo "kubectl rollout status deployment/airiss-backend"
        
        # ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ë‹¤ìŒê³¼ ê°™ì€ ëª…ë ¹ì–´ ì‚¬ìš©:
        # kubectl set image deployment/airiss-backend airiss=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ needs.generate-release-notes.outputs.version }}
        # kubectl rollout status deployment/airiss-backend

    - name: ğŸ¥ Health Check
      run: |
        echo "ğŸ¥ Performing health check..."
        # ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” í—¬ìŠ¤ì²´í¬ API í˜¸ì¶œ
        # curl -f https://airiss.okfinancial.com/health || exit 1

    - name: ğŸ“Š Update monitoring
      run: |
        echo "ğŸ“Š Updating monitoring dashboards..."
        echo "Version: ${{ needs.generate-release-notes.outputs.version }}"
        echo "Deployment time: $(date)"

  # ================================
  # ë¦´ë¦¬ì¦ˆ í›„ ì‘ì—…
  # ================================
  post-release:
    name: ğŸ“® Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [generate-release-notes, deploy-production]
    if: always() && needs.generate-release-notes.result == 'success'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ“§ Send release notification
      run: |
        echo "ğŸ“§ Sending release notification..."
        echo "âœ… AIRISS ${{ needs.generate-release-notes.outputs.version }} has been released!"
        echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.generate-release-notes.outputs.version }}"
        
        # ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” Slack, Teams, ì´ë©”ì¼ ë“±ìœ¼ë¡œ ì•Œë¦¼ ë°œì†¡
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ğŸš€ AIRISS ${{ needs.generate-release-notes.outputs.version }} released!"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: ğŸ“Š Update documentation
      run: |
        echo "ğŸ“Š Updating documentation..."
        echo "API documentation will be updated with new version"
        # ì‹¤ì œë¡œëŠ” API ë¬¸ì„œ ìë™ ì—…ë°ì´íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

    - name: ğŸ”„ Create next development branch
      run: |
        echo "ğŸ”„ Setting up next development cycle..."
        # ë‹¤ìŒ ê°œë°œ ë¸Œëœì¹˜ ìƒì„± ë¡œì§
        CURRENT_VERSION="${{ needs.generate-release-notes.outputs.version }}"
        echo "Current version: $CURRENT_VERSION"
        echo "Next development branch setup complete"

  # ================================
  # ë¡¤ë°± ì¤€ë¹„
  # ================================
  prepare-rollback:
    name: ğŸ”„ Prepare Rollback
    runs-on: ubuntu-latest
    needs: [generate-release-notes, deploy-production]
    if: failure()
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”„ Prepare rollback information
      run: |
        echo "ğŸš¨ Deployment failed! Preparing rollback information..."
        echo "Failed version: ${{ needs.generate-release-notes.outputs.version }}"
        echo "Rollback procedure:"
        echo "1. kubectl rollout undo deployment/airiss-backend"
        echo "2. Verify previous version is running"
        echo "3. Update DNS if necessary"
        echo "4. Send incident notification"

    - name: ğŸ“ Create incident report
      run: |
        echo "ğŸ“ Creating incident report..."
        echo "Timestamp: $(date)"
        echo "Failed Release: ${{ needs.generate-release-notes.outputs.version }}"
        echo "Workflow Run: ${{ github.run_id }}"
        echo "Repository: ${{ github.repository }}"
