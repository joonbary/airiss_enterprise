# AIRISS ìžë™ ë°±ì—… ì›Œí¬í”Œë¡œìš°
name: ðŸ”„ AIRISS ìžë™ ë°±ì—…

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (KST 11ì‹œ)ì— ì‹¤í–‰
    - cron: '0 2 * * *'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  push:
    branches:
      - main
    tags:
      - 'v*'

jobs:
  backup:
    name: ðŸ“¦ í”„ë¡œì íŠ¸ ë°±ì—…
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ”„ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # ì „ì²´ ížˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
        
    - name: ðŸ“… ë‚ ì§œ ì„¤ì •
      run: |
        echo "BACKUP_DATE=$(date +'%Y-%m-%d_%H-%M')" >> $GITHUB_ENV
        echo "YEAR_MONTH=$(date +'%Y-%m')" >> $GITHUB_ENV
        
    - name: ðŸ—ƒï¸ ë°±ì—… ì•„ì¹´ì´ë¸Œ ìƒì„±
      run: |
        # ë°±ì—… ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p backups/$YEAR_MONTH
        
        # ì „ì²´ í”„ë¡œì íŠ¸ ì••ì¶• (ì¤‘ìš” íŒŒì¼ë§Œ)
        tar -czf backups/$YEAR_MONTH/airiss_backup_$BACKUP_DATE.tar.gz \
          --exclude='.git' \
          --exclude='node_modules' \
          --exclude='__pycache__' \
          --exclude='venv' \
          --exclude='*.pyc' \
          --exclude='.env' \
          --exclude='uploads' \
          --exclude='logs' \
          --exclude='temp_data' \
          .
          
        # ë°ì´í„°ë² ì´ìŠ¤ ë³„ë„ ë°±ì—…
        if [ -f "airiss.db" ]; then
          cp airiss.db backups/$YEAR_MONTH/airiss_db_$BACKUP_DATE.db
        fi
        
        # ë°±ì—… ì •ë³´ íŒŒì¼ ìƒì„±
        cat > backups/$YEAR_MONTH/backup_info_$BACKUP_DATE.txt << EOF
        AIRISS ë°±ì—… ì •ë³´
        =================
        ë°±ì—… ì¼ì‹œ: $(date +'%Y-%m-%d %H:%M:%S KST')
        Git ì»¤ë°‹: $(git rev-parse HEAD)
        ë¸Œëžœì¹˜: $(git branch --show-current)
        ë°±ì—… í¬ê¸°: $(du -h backups/$YEAR_MONTH/airiss_backup_$BACKUP_DATE.tar.gz | cut -f1)
        
        í¬í•¨ëœ íŒŒì¼:
        - ì†ŒìŠ¤ ì½”ë“œ ì „ì²´
        - ì„¤ì • íŒŒì¼
        - ë°ì´í„°ë² ì´ìŠ¤ (airiss.db)
        - ë¬¸ì„œ
        
        ì œì™¸ëœ íŒŒì¼:
        - .git ížˆìŠ¤í† ë¦¬
        - node_modules
        - Python ìºì‹œ
        - ë¡œê·¸ íŒŒì¼
        - ìž„ì‹œ íŒŒì¼
        EOF
        
    - name: ðŸ“¤ ë°±ì—… íŒŒì¼ ì—…ë¡œë“œ (Artifacts)
      uses: actions/upload-artifact@v4
      with:
        name: airiss-backup-${{ env.BACKUP_DATE }}
        path: backups/
        retention-days: 90 # 90ì¼ ë³´ê´€
        
    - name: ðŸ“Š ë°±ì—… ì™„ë£Œ ì•Œë¦¼
      run: |
        echo "âœ… AIRISS ë°±ì—… ì™„ë£Œ!"
        echo "ðŸ“… ë°±ì—… ì¼ì‹œ: $(date +'%Y-%m-%d %H:%M:%S')"
        echo "ðŸ“ ë°±ì—… íŒŒì¼: airiss_backup_$BACKUP_DATE.tar.gz"
        echo "ðŸ’¾ ë°ì´í„°ë² ì´ìŠ¤: airiss_db_$BACKUP_DATE.db"
        
  # ì˜¤ëž˜ëœ ë°±ì—… ì •ë¦¬ (ì„ íƒì‚¬í•­)
  cleanup-old-backups:
    name: ðŸ§¹ ì˜¤ëž˜ëœ ë°±ì—… ì •ë¦¬
    runs-on: ubuntu-latest
    needs: backup
    if: github.event_name == 'schedule' # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ì‹œë§Œ
    
    steps:
    - name: ðŸ—‘ï¸ 30ì¼ ì´ìƒ ëœ ì•„í‹°íŒ©íŠ¸ ì‚­ì œ
      uses: actions/github-script@v7
      with:
        script: |
          const cutoffDate = new Date();
          cutoffDate.setDate(cutoffDate.getDate() - 30);
          
          const artifacts = await github.rest.actions.listArtifactsForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          for (const artifact of artifacts.data.artifacts) {
            if (artifact.name.startsWith('airiss-backup-') && 
                new Date(artifact.created_at) < cutoffDate) {
              await github.rest.actions.deleteArtifact({
                owner: context.repo.owner,
                repo: context.repo.repo,
                artifact_id: artifact.id
              });
              console.log(`ì‚­ì œë¨: ${artifact.name}`);
            }
          }
