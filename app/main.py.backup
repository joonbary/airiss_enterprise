# app/main.py
# AIRISS v4.0 메인 서버 - React 통합 및 프로덕션 최적화 버전

from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from contextlib import asynccontextmanager
import logging
import os
import uvicorn
from typing import Dict, List
from datetime import datetime
import traceback
from pathlib import Path

# 프로젝트 모듈 import
from app.core.websocket_manager import ConnectionManager

# 로깅 설정
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# 전역 설정
SERVER_HOST = os.getenv("SERVER_HOST", "0.0.0.0")
SERVER_PORT = int(os.getenv("SERVER_PORT", "8002"))
WS_HOST = os.getenv("WS_HOST", "localhost")
ENVIRONMENT = os.getenv("ENVIRONMENT", "development")

# WebSocket 연결 관리자 인스턴스 생성
manager = ConnectionManager()

# React 빌드 파일 경로 설정
REACT_BUILD_PATH = Path(__file__).parent.parent / "airiss-v4-frontend" / "build"
REACT_STATIC_PATH = REACT_BUILD_PATH / "static"

# Startup 이벤트 처리 함수
async def startup_event():
    """애플리케이션 시작 시 실행"""
    logger.info("📋 Registered routes:")
    route_count = 0
    
    for route in app.routes:
        if hasattr(