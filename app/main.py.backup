# app/main.py
# AIRISS v4.0 ë©”ì¸ ì„œë²„ - React í†µí•© ë° í”„ë¡œë•ì…˜ ìµœì í™” ë²„ì „

from fastapi import FastAPI, WebSocket, WebSocketDisconnect
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse, JSONResponse
from fastapi.staticfiles import StaticFiles
from contextlib import asynccontextmanager
import logging
import os
import uvicorn
from typing import Dict, List
from datetime import datetime
import traceback
from pathlib import Path

# í”„ë¡œì íŠ¸ ëª¨ë“ˆ import
from app.core.websocket_manager import ConnectionManager

# ë¡œê¹… ì„¤ì •
logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)

# ì „ì—­ ì„¤ì •
SERVER_HOST = os.getenv("SERVER_HOST", "0.0.0.0")
SERVER_PORT = int(os.getenv("SERVER_PORT", "8002"))
WS_HOST = os.getenv("WS_HOST", "localhost")
ENVIRONMENT = os.getenv("ENVIRONMENT", "development")

# WebSocket ì—°ê²° ê´€ë¦¬ì ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
manager = ConnectionManager()

# React ë¹Œë“œ íŒŒì¼ ê²½ë¡œ ì„¤ì •
REACT_BUILD_PATH = Path(__file__).parent.parent / "airiss-v4-frontend" / "build"
REACT_STATIC_PATH = REACT_BUILD_PATH / "static"

# Startup ì´ë²¤íŠ¸ ì²˜ë¦¬ í•¨ìˆ˜
async def startup_event():
    """ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ì‹¤í–‰"""
    logger.info("ğŸ“‹ Registered routes:")
    route_count = 0
    
    for route in app.routes:
        if hasattr(